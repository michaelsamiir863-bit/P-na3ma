<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:tahoma;
  background:#eef1f4;
  margin:0;
  padding:12px;
}

/* ====== Layout ====== */
.container{
  max-width:1100px;
  margin:auto;
}

.card{
  background:#fff;
  border-radius:10px;
  padding:12px;
  margin-bottom:15px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}

.card h3{
  margin:0 0 10px;
  font-size:15px;
  border-bottom:1px solid #ddd;
  padding-bottom:6px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}

input,button{
  padding:7px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #ccc;
}

button{
  background:#1e88e5;
  color:#fff;
  border:none;
  cursor:pointer;
}

button.secondary{
  background:#555;
}

button.danger{
  background:#c62828;
}

.list{
  border:1px solid #ccc;
  max-height:120px;
  overflow:auto;
  margin-top:4px;
}

.list div{
  padding:6px;
  cursor:pointer;
}
.list div:hover{background:#f0f0f0}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #000;
  padding:5px;
  text-align:center;
  font-size:12px;
}

/* ====== Modal ====== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  width:90%;
  max-width:800px;
  padding:12px;
  border-radius:10px;
}
</style>
</head>
<body>

<div class="container">

<!-- =================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© =================== -->
<div class="card">
<h3>ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
<div class="grid">
  <input type="date" id="invDate" onchange="setDay()">
  <input id="invDay" placeholder="Ø§Ù„ÙŠÙˆÙ…" disabled>

  <div>
    <input id="supplierSearch" placeholder="Ø¨Ø­Ø« Ù…ÙˆØ±Ø¯" oninput="filterSuppliers()">
    <div id="supplierList" class="list"></div>
  </div>

  <input id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
</div>
<b>Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±:</b> <span id="selectedSupplier"></span>
</div>

<!-- =================== Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù =================== -->
<div class="card">
<h3>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3>

<input id="productSearch" placeholder="Ø¨Ø­Ø« ØµÙ†Ù" oninput="filterProducts()">
<div id="productList" class="list"></div>
<b>Ø§Ù„ØµÙ†Ù:</b> <span id="selectedProduct"></span>

<div class="grid" style="margin-top:8px">
  <input id="qty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <input id="buyPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
  <input id="publicPrice" disabled placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±">
  <button onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>
</div>

<!-- =================== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù =================== -->
<div class="card">
<h3>ğŸ§¾ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø®ØµÙ… %</th>
</tr>
</thead>
<tbody id="itemsTable"></tbody>
</table>
</div>

<!-- =================== Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª =================== -->
<div class="card">
<h3>ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</h3>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±: <b id="totalPublic">0</b></p>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡: <b id="totalBuy">0</b></p>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…: <b id="totalDiscount">0</b></p>
<p>Ø§Ù„ØµØ§ÙÙŠ: <b id="netTotal">0</b></p>
<button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<button class="secondary" onclick="openModal()">ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>

</div>

<!-- =================== Modal =================== -->
<div class="modal" id="modal">
<div class="modal-content">
<h3>ğŸ“‚ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>

<div class="grid">
  <input type="date" id="filterDate">
  <input id="filterSupplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯">
  <button onclick="applyFilter()">Ø¨Ø­Ø«</button>
  <button class="danger" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<div id="oldInvoices"></div>
</div>
</div>

<script>
firebase.initializeApp({
  databaseURL:"https://system-ph-77a0a-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

let products={},suppliers={},items=[];
let currentProduct=null,currentSupplier=null;

/* ØªØ­Ù…ÙŠÙ„ */
db.ref("products").on("value",s=>products=s.val()||{});
db.ref("suppliers").on("value",s=>suppliers=s.val()||{});

/* Ø§Ù„ÙŠÙˆÙ… */
function setDay(){
  const d=new Date(invDate.value);
  invDay.value=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"][d.getDay()];
}

/* Ø§Ù„Ù…ÙˆØ±Ø¯ */
function filterSuppliers(){
  supplierList.innerHTML="";
  const q=supplierSearch.value;
  for(let id in suppliers){
    if(suppliers[id].name.includes(q)){
      supplierList.innerHTML+=`<div onclick="selectSupplier('${suppliers[id].name}')">${suppliers[id].name}</div>`;
    }
  }
}
function selectSupplier(n){
  currentSupplier=n;
  selectedSupplier.innerText=n;
  supplierList.innerHTML="";
  supplierSearch.value="";
}

/* ØµÙ†Ù */
function filterProducts(){
  productList.innerHTML="";
  const q=productSearch.value;
  for(let id in products){
    if(products[id].name.includes(q)){
      productList.innerHTML+=`<div onclick="selectProduct('${id}')">${products[id].name}</div>`;
    }
  }
}
function selectProduct(id){
  currentProduct=products[id];
  selectedProduct.innerText=currentProduct.name;
  publicPrice.value=currentProduct.publicPrice;
  productList.innerHTML="";
}

/* Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù */
function addItem(){
  const discount=((currentProduct.publicPrice-buyPrice.value)/currentProduct.publicPrice*100).toFixed(2);
  items.push({
    name:currentProduct.name,
    qty:+qty.value,
    publicPrice:currentProduct.publicPrice,
    buyPrice:+buyPrice.value,
    discount
  });
  renderItems();
}

/* Ø¹Ø±Ø¶ */
function renderItems(){
  let tp=0,tb=0;
  itemsTable.innerHTML="";
  items.forEach(i=>{
    tp+=i.publicPrice*i.qty;
    tb+=i.buyPrice*i.qty;
    itemsTable.innerHTML+=`
    <tr>
      <td>${i.name}</td>
      <td>${i.qty}</td>
      <td>${i.publicPrice}</td>
      <td>${i.buyPrice}</td>
      <td>${i.discount}%</td>
    </tr>`;
  });
  totalPublic.innerText=tp;
  totalBuy.innerText=tb;
  totalDiscount.innerText=tp-tb;
  netTotal.innerText=tb;
}

/* Ø­ÙØ¸ */
function saveInvoice(){
  db.ref("purchaseInvoices").push({
    date:invDate.value,
    day:invDay.value,
    supplier:currentSupplier,
    notes:notes.value,
    items,
    netTotal:netTotal.innerText
  });
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”");
  items=[];
  renderItems();
}

/* ===== Modal ===== */
function openModal(){modal.style.display="flex"}
function closeModal(){modal.style.display="none"}

function applyFilter(){
  db.ref("purchaseInvoices").once("value",s=>{
    oldInvoices.innerHTML="";
    const d=s.val()||{};
    for(let id in d){
      if(
        (filterDate.value && d[id].date!==filterDate.value) ||
        (filterSupplier.value && d[id].supplier!==filterSupplier.value)
      ) continue;

      oldInvoices.innerHTML+=`
      <div class="card">
        ØªØ§Ø±ÙŠØ®: ${d[id].date} | Ù…ÙˆØ±Ø¯: ${d[id].supplier}<br>
        ØµØ§ÙÙŠ: ${d[id].netTotal}
        <button onclick='printInvoice(${JSON.stringify(d[id])})'>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>`;
    }
  });
}

/* Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠØ© */
function printInvoice(inv){
  const w=window.open("","","width=300");
  w.document.write(`
  <body style="font-family:tahoma;font-size:11px;width:58mm">
  <center><b>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</b><br>${inv.date}<br>${inv.supplier}</center><hr>
  ${inv.items.map(i=>`${i.name} Ã— ${i.qty}<br>Ø¬:${i.publicPrice} Ø´:${i.buyPrice}<br>`).join("")}
  <hr><b>Ø§Ù„ØµØ§ÙÙŠ: ${inv.netTotal}</b>
  </body>
  `);
  w.print(); w.close();
}
</script>

</body>
</html>
