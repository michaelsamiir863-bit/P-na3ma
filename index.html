<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:Tahom,aArial;
  background:#f4f6f8;
  margin:0;padding:10px
}
.container{
  background:#fff;
  border-radius:10px;
  padding:15px;
  box-shadow:0 2px 8px rgba(0,0,0,.15)
}
h2{text-align:center;margin:0 0 10px}

.row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-bottom:8px
}
input,textarea{
  padding:7px;
  border:1px solid #ccc;
  border-radius:6px;
  width:100%
}
textarea{resize:none}

.search-box{position:relative}
.results{
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  width:100%;
  max-height:160px;
  overflow:auto;
  z-index:99
}
.results div{
  padding:6px;
  cursor:pointer
}
.results div:hover{background:#eee}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px
}
th,td{
  border:1px solid #000;
  padding:5px;
  text-align:center;
  font-size:14px
}
th{background:#eee}

.buttons{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap
}
button{
  padding:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:15px
}
.add{background:#0d6efd;color:#fff}
.save{background:#198754;color:#fff}
.prev{background:#6c757d;color:#fff}
.admin{background:#111;color:#fff;width:100%}

.totals{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-top:10px
}
.totals div{
  background:#f1f1f1;
  padding:8px;
  border-radius:6px;
  text-align:center;
  font-weight:bold
}

/* modal */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:100
}
.modal-content{
  background:#fff;
  margin:5%;
  padding:10px;
  border-radius:10px;
  max-height:85%;
  overflow:auto
}
.close{
  float:left;
  cursor:pointer;
  font-size:20px
}

@media(max-width:768px){
  .row{grid-template-columns:1fr 1fr}
  .totals{grid-template-columns:1fr 1fr}
}
</style>
</head>

<body>

<div class="container">
<h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h2>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="row">
  <input type="date" id="date">
  <input type="text" id="day" placeholder="Ø§Ù„ÙŠÙˆÙ…" readonly>

  <div class="search-box">
    <input id="supplierSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ±Ø¯">
    <div class="results" id="supplierResults"></div>
  </div>

  <input id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
</div>

<!-- Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù -->
<div class="row">
  <div class="search-box">
    <input id="itemSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù">
    <div class="results" id="itemResults"></div>
  </div>
  <input type="number" id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <input type="number" id="bonus" placeholder="Ø§Ù„Ø¨ÙˆÙ†Øµ">
  <input type="number" id="buyPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
</div>

<button class="add" onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>

<table>
<thead>
<tr>
<th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¨ÙˆÙ†Øµ</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</th><th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø®ØµÙ… %</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
</tr>
</thead>
<tbody id="itemsBody"></tbody>
</table>

<div class="totals">
<div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±<br><span id="tp">0</span></div>
<div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡<br><span id="tb">0</span></div>
<div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…<br><span id="td">0</span></div>
<div>ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©<br><span id="net">0</span></div>
</div>

<div class="buttons">
<button class="save" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸</button>
<button class="prev" onclick="openModal()">ğŸ“„ ÙÙˆØ§ØªÙŠØ± Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<a target="_blank" href="https://sites.google.com/view/p-na3ma/%D8%A7%D9%84%D8%A7%D8%B5%D9%86%D8%A7%D9%81">
<button class="admin">âš™ï¸ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
</a>
</div>

<!-- modal -->
<div class="modal" id="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">âœ–</span>
<h3>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>

<div class="row">
<input type="date" id="filterDate">
<input placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" id="filterSupplier">
</div>

<table>
<thead>
<tr>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
<th>Ø·Ø¨Ø§Ø¹Ø©</th>
</tr>
</thead>
<tbody id="prevBody"></tbody>
</table>

</div>
</div>

<script>
const app=firebase.initializeApp({
 databaseURL:"https://system-ph-77a0a-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

let suppliers={},itemsDB={},selectedSupplier=null,selectedItem=null,items=[];

/* Ø§Ù„ÙŠÙˆÙ… */
date.onchange=()=>{
 const d=new Date(date.value);
 day.value=d.toLocaleDateString('ar-EG',{weekday:'long'});
};

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
db.ref("suppliers").on("value",s=>suppliers=s.val()||{});
db.ref("items").on("value",s=>itemsDB=s.val()||{});

/* Ø¨Ø­Ø« Ù…ÙˆØ±Ø¯ */
supplierSearch.oninput=()=>{
 supplierResults.innerHTML="";
 Object.values(suppliers).filter(s=>s.name.includes(supplierSearch.value))
 .forEach(s=>{
  const d=document.createElement("div");
  d.textContent=s.name;
  d.onclick=()=>{supplierSearch.value=s.name;selectedSupplier=s;supplierResults.innerHTML=""};
  supplierResults.appendChild(d);
 });
};

/* Ø¨Ø­Ø« ØµÙ†Ù */
itemSearch.oninput=()=>{
 itemResults.innerHTML="";
 Object.values(itemsDB).filter(i=>i.name.includes(itemSearch.value))
 .forEach(i=>{
  const d=document.createElement("div");
  d.textContent=i.name;
  d.onclick=()=>{itemSearch.value=i.name;selectedItem=i;itemResults.innerHTML=""};
  itemResults.appendChild(d);
 });
};

/* Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù */
function addItem(){
 if(!selectedItem)return alert("Ø§Ø®ØªØ± ØµÙ†Ù");
 const q=+qty.value,b=+bonus.value,p=+buyPrice.value;
 const pub=+selectedItem.publicPrice;
 const disc=((pub-p)/pub*100).toFixed(1);
 const total=q*p;
 items.push({name:selectedItem.name,q,b,pub,p,disc,total});
 render();
}

/* Ø¹Ø±Ø¶ */
function render(){
 itemsBody.innerHTML="";
 let TP=0,TB=0;
 items.forEach(i=>{
  TP+=i.q*i.pub; TB+=i.total;
  itemsBody.innerHTML+=`<tr>
  <td>${i.name}</td><td>${i.q}</td><td>${i.b}</td>
  <td>${i.pub}</td><td>${i.p}</td>
  <td>${i.disc}%</td><td>${i.total}</td></tr>`;
 });
 tp.textContent=TP;
 tb.textContent=TB;
 td.textContent=(TP-TB).toFixed(2);
 net.textContent=TB;
}

/* Ø­ÙØ¸ */
function saveInvoice(){
 if(!selectedSupplier)return alert("Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯");
 const id=Date.now();
 db.ref("purchaseInvoices/"+id).set({
  date:date.value,day:day.value,
  supplier:selectedSupplier.name,
  notes:notes.value,
  items,totals:{tp:tp.textContent,tb:tb.textContent,td:td.textContent,net:net.textContent}
 });
 alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}

/* modal */
function openModal(){modal.style.display="block";loadPrev()}
function closeModal(){modal.style.display="none"}

function loadPrev(){
 prevBody.innerHTML="";
 db.ref("purchaseInvoices").once("value",s=>{
  s.forEach(c=>{
   const v=c.val();
   if(filterDate.value && v.date!==filterDate.value)return;
   if(filterSupplier.value && !v.supplier.includes(filterSupplier.value))return;
   prevBody.innerHTML+=`<tr>
   <td>${v.date}</td><td>${v.supplier}</td><td>${v.totals.net}</td>
   <td><button onclick='printInv(${JSON.stringify(v)})'>ğŸ–¨ï¸</button></td>
   </tr>`;
  });
 });
}

/* Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³ÙŠØª */
function printInv(v){
 const w=window.open("","", "width=300");
 let h=`<h3>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
 <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}</p>
 <p>Ø§Ù„Ù…ÙˆØ±Ø¯: ${v.supplier}</p>
 <table border=1 width=100%>
 <tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ùƒ</th><th>Ø³ Ø¬</th><th>Ø³ Ø´</th><th>%</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>`;
 v.items.forEach(i=>{
  h+=`<tr><td>${i.name}</td><td>${i.q}</td><td>${i.pub}</td><td>${i.p}</td><td>${i.disc}</td><td>${i.total}</td></tr>`;
 });
 h+=`</table><h4>Ø§Ù„ØµØ§ÙÙŠ: ${v.totals.net}</h4>`;
 w.document.write(h);
 w.print();
}
</script>

</body>
</html>
