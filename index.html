<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family: Tahoma, Arial;
  background:#f4f6f8;
  margin:0;
  padding:15px;
}
.container{
  background:#fff;
  padding:15px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}
h2{
  margin:0 0 10px;
  text-align:center;
}
.row{
  display:grid;
  grid-template-columns: repeat(4,1fr);
  gap:10px;
  margin-bottom:10px;
}
input, textarea{
  width:100%;
  padding:8px;
  border:1px solid #ccc;
  border-radius:5px;
}
textarea{ resize:none }

.search-box{
  position:relative;
}
.search-results{
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  width:100%;
  max-height:150px;
  overflow:auto;
  z-index:10;
}
.search-results div{
  padding:6px;
  cursor:pointer;
}
.search-results div:hover{
  background:#eee;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #000;
  padding:6px;
  text-align:center;
}
th{
  background:#eee;
}

.total-box{
  display:grid;
  grid-template-columns: repeat(4,1fr);
  gap:10px;
  margin-top:10px;
}
.total-box div{
  background:#f1f1f1;
  padding:10px;
  border-radius:5px;
  text-align:center;
  font-weight:bold;
}

button{
  padding:10px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:15px;
}
.btn-add{background:#0d6efd;color:#fff}
.btn-save{background:#198754;color:#fff}
.btn-prev{background:#6c757d;color:#fff}
</style>
</head>

<body>

<div class="container">
<h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h2>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="row">
  <input type="date" id="date">
  <input type="text" id="day" placeholder="Ø§Ù„ÙŠÙˆÙ…" readonly>
  
  <div class="search-box">
    <input type="text" id="supplierSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ±Ø¯">
    <div class="search-results" id="supplierResults"></div>
  </div>

  <input type="text" id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
</div>

<!-- Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù -->
<div class="row">
  <div class="search-box">
    <input type="text" id="itemSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù">
    <div class="search-results" id="itemResults"></div>
  </div>
  <input type="number" id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <input type="number" id="bonus" placeholder="Ø§Ù„Ø¨ÙˆÙ†Øµ">
  <input type="number" id="buyPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
</div>

<button class="btn-add" onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>

<table>
<thead>
<tr>
<th>Ø§Ù„ØµÙ†Ù</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø§Ù„Ø¨ÙˆÙ†Øµ</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø®ØµÙ… %</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
</tr>
</thead>
<tbody id="itemsBody"></tbody>
</table>

<div class="total-box">
  <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±<br><span id="totalPublic">0</span></div>
  <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡<br><span id="totalBuy">0</span></div>
  <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…<br><span id="totalDiscount">0</span></div>
  <div>ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©<br><span id="netTotal">0</span></div>
</div>

<br>
<button class="btn-save" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
<button class="btn-prev" onclick="openPrev()">ğŸ“„ ÙÙˆØ§ØªÙŠØ± Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<script>
const firebaseConfig={
  databaseURL:"https://system-ph-77a0a-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let selectedItem=null;
let selectedSupplier=null;
let items=[];

// Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ
document.getElementById("date").addEventListener("change",e=>{
  const d=new Date(e.target.value);
  document.getElementById("day").value=
  d.toLocaleDateString('ar-EG',{weekday:'long'});
});

// Ø¨Ø­Ø« Ù…ÙˆØ±Ø¯ÙŠÙ†
db.ref("suppliers").on("value",s=>{
  window.suppliers=s.val()||{};
});
supplierSearch.oninput=()=>{
  supplierResults.innerHTML="";
  Object.values(suppliers||{}).filter(x=>x.name.includes(supplierSearch.value))
  .forEach(s=>{
    const d=document.createElement("div");
    d.textContent=s.name;
    d.onclick=()=>{
      supplierSearch.value=s.name;
      selectedSupplier=s;
      supplierResults.innerHTML="";
    }
    supplierResults.appendChild(d);
  })
}

// Ø¨Ø­Ø« Ø£ØµÙ†Ø§Ù
db.ref("items").on("value",s=>{
  window.itemsDB=s.val()||{};
});
itemSearch.oninput=()=>{
  itemResults.innerHTML="";
  Object.values(itemsDB||{}).filter(x=>x.name.includes(itemSearch.value))
  .forEach(i=>{
    const d=document.createElement("div");
    d.textContent=i.name;
    d.onclick=()=>{
      itemSearch.value=i.name;
      selectedItem=i;
      itemResults.innerHTML="";
    }
    itemResults.appendChild(d);
  })
}

function addItem(){
  if(!selectedItem)return alert("Ø§Ø®ØªØ± ØµÙ†Ù");
  const q=+qty.value,b=+bonus.value,p=+buyPrice.value;
  const pub=+selectedItem.publicPrice;
  const disc=((pub-p)/pub*100).toFixed(1);
  const total=q*p;
  items.push({name:selectedItem.name,q,b,pub,p,disc,total});
  render();
}

function render(){
  itemsBody.innerHTML="";
  let tp=0,tb=0;
  items.forEach(i=>{
    tp+=i.q*i.pub;
    tb+=i.total;
    itemsBody.innerHTML+=`
    <tr>
      <td>${i.name}</td>
      <td>${i.q}</td>
      <td>${i.b}</td>
      <td>${i.pub}</td>
      <td>${i.p}</td>
      <td>${i.disc}%</td>
      <td>${i.total}</td>
    </tr>`;
  });
  totalPublic.textContent=tp;
  totalBuy.textContent=tb;
  totalDiscount.textContent=(tp-tb).toFixed(2);
  netTotal.textContent=tb;
}

function saveInvoice(){
  const id=Date.now();
  db.ref("purchaseInvoices/"+id).set({
    date:date.value,
    day:day.value,
    supplier:selectedSupplier.name,
    notes:notes.value,
    items,
    totals:{
      public:totalPublic.textContent,
      buy:totalBuy.textContent,
      discount:totalDiscount.textContent,
      net:netTotal.textContent
    }
  });
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
}

function openPrev(){
  alert("ØµÙØ­Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© ØªÙƒÙˆÙ† ÙÙŠ ØµÙØ­Ø© Ù…Ù†ÙØµÙ„Ø©");
}
</script>

</body>
</html>

